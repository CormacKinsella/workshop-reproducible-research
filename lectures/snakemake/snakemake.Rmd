---
title: "Managing your data"
subtitle: "Tools for Reproducible Research NBIS course"
output:
  xaringan::moon_reader:
      self-contained: true
      seal: false
      css: ["default", "template.css"]
      nature:
          slideNumberFormat: ""

---

layout: true
<div class="scilife-logo"></div>
<div class="nbis-logo"></div>

---

class: center, middle

*Making reproducible workflows with*

<img src="https://snakemake.github.io/img/jk/logo.png" style="background-color:#002221;width:50%;padding: 15px 15px 15px 15px;">

---

# Why do we need workflow managers?
--
<br>
.pull-left[
<img src="https://images.unsplash.com/photo-1549319114-d67887c51aed?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1867&q=80" width="90%">
]
.pull-right[
*As projects grow or age, it becomes increasingly difficult to keep track of all the parts and how they fit together.*
]

---

# Snakemake workflows

- automatically tracks input/output file dependencies
- are built from .green[rules] and generalized with .green[wildcards]
- uses a .green[Python-based] definition language
- easily scale from laptops to HPC clusters

---

# Example: sequence trimming

Using a bash-script:
```bash
for sample in *.fastq
do  
   id=$(echo ${sample} | sed 's/.fastq//')  
   
   # Trim fastq file
   echo “Trimming ${id}“
   seqtk trimfq -b 5 -e 10 $sample > \
   ${id}.trimmed.fastq

   # Compress fastq file
   echo “Compressing ${id}“
   gzip -c ${id}.trimmed.fastq > \
   ${id}.trimmed.fastq.gz

   # Remove intermediate files  
   rm ${id}.trimmed.fastq
done
```

---
# Example: sequence trimming
Using snakemake rules:

```python
rule trim_fastq:
    input: "{prefix}.fastq"
    output: temp("{prefix}.trimmed.fastq")
    shell:
        "seqtk trimfq -b 5 -e 10 {input} > {output}"

rule gzip:
    input: "{prefix}"
    output: "{prefix}.gz"
    shell:
        "gzip -c {input} > {output}"
```

```
$ snakemake {a,b}.trimmed.fastq.gz
```

---

.pull-left[
Snakemake figures out how rules can be pieced together to generate some requested output.

Here we ask for .green[supplementary.pdf], which is an R Markdown report generated by the rule make_supplementary.

]

.pull-right[
<img src="figures/rulegraph.png">

`$ snakemake supplementary.pdf`
]

---

# Anatomy of a Snakemake rule
```
rule trim_fastq:
```
--
```
    input: "{prefix}.fastq"
    output: temp("{prefix}.trimmed.fastq")
    log: "logs/{prefix}.trim_fastq.log"
```
--
```
    shell:
        """
        seqtk trimfq -t 8 –b 5 -e 10 {input} > {output} 2> {log}
        """
```
---

# Anatomy of a Snakemake rule
```
rule trim_fastq:
```
```
    input: "{prefix}.fastq"
    output: temp("{prefix}.trimmed.fastq")
    log: "logs/{prefix}.trim_fastq.log"
```
```
    # rule settings
    params:
        leftTrim=5,
        rightTrim=10
```
--
```
    # resources
    threads: 8
    resources: mem=64
```
--
```
    # software management
    conda: "envs/seqtk.yaml"
    singularity: "docker://quay.io/biocontainers/seqtk"
```
--
```
    shell:
      """
      seqtk trimfq -t {threads} –b {params.leftTrim}
                   -e {params.rightTrim} {input} > {output} 2> {log}
      """
```
---

# Snakemake commandline

```bash
# Generate the output of the first rule in Snakefile 
$ snakemake -s Snakefile

# Target a specific file as output
$ snakemake a.trimmed.fastq.gz

# Execute the workflow with 8 cores
$ snakemake --cores 8

# Specify a configuration file and print shell commands
$ snakemake --configfile config.yaml -p

# Run rules with specific conda environments
$ snakemake --use-conda
```
---

class: center, middle

# Questions?

